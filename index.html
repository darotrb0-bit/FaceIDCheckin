<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធវត្តមានបុគ្គលិក Face Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Khmer', 'Koulen', sans-serif;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 0.5rem;
        }
        .log-entry {
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateX(20px);
        }
        .log-entry.visible {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl bg-white rounded-lg shadow-xl p-6">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-4" style="font-family: 'Moul', cursive;">ប្រព័ន្ធគ្រប់គ្រងវត្តមានស្វ័យប្រវត្តិ</h1>
        
        <div class="grid md:grid-cols-2 gap-8 items-start">
            <!-- Camera View -->
            <div class="w-full">
                <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden shadow-inner flex items-center justify-center">
                    <video id="video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <canvas id="overlay"></canvas>
                    <div id="loader" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-20">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                        <p id="loader-text" class="mt-4 text-gray-700 font-semibold">កំពុងរៀបចំប្រព័ន្ធ...</p>
                    </div>
                </div>
                <p class="text-center text-gray-500 mt-2">សូមដាក់មុខរបស់លោកអ្នកនៅមុខកាមេរ៉ា</p>
            </div>

            <!-- Attendance Log Panel -->
            <div id="log-panel" class="w-full h-[360px] md:h-full flex flex-col">
                 <h2 class="text-xl font-bold text-gray-700 mb-3 text-center border-b-2 pb-2">បញ្ជីវត្តមានថ្ងៃនេះ</h2>
                 <div id="log-container" class="space-y-2 overflow-y-auto flex-grow pr-2">
                    <!-- Log entries will be added here dynamically -->
                    <div id="default-log-message" class="flex items-center justify-center h-full text-gray-400">
                        <span>មិនទាន់មានទិន្នន័យនៅឡើយទេ...</span>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <script>
        // ================== CONFIGURATION ==================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxwSJYdzVMweOyJbPJ-ChnRE01vX0rS04tlfYPPp687_y4_LP4ilFPwBB5joPe-_91u/exec';
        const RECOGNITION_COOLDOWN = 30000; // 30 seconds cooldown for the same person
        const MAX_LOG_ENTRIES = 8;
        // ===============================================

        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const logContainer = document.getElementById('log-container');
        const defaultLogMessage = document.getElementById('default-log-message');

        let employeeData = [];
        let faceMatcher = null;
        let recognitionInterval = null;
        const recentlyProcessed = new Map();

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                loaderText.textContent = "Error: មិនអាចបើកកាមេរ៉ាបានទេ។";
            }
        }
        
        async function loadModels() {
            // Loading models from the local 'models' folder
            const MODEL_URL = 'models'; 
            loaderText.textContent = 'កំពុងទាញយក Models...';
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
            } catch (error) {
                console.error("Error loading models:", error);
                loaderText.textContent = "បរាជ័យក្នុងការទាញយក Models។";
            }
        }

        async function getLabeledFaceDescriptors() {
            loaderText.textContent = 'កំពុងទាញយកបញ្ជីបុគ្គលិក...';
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                
                employeeData = await response.json();
                if (!Array.isArray(employeeData)) throw new Error("Invalid data format from server.");

                loaderText.textContent = `រកឃើញ ${employeeData.length} នាក់។ កំពុងវិភាគរូបថត...`;

                const descriptors = await Promise.all(
                    employeeData.map(async (employee, index) => {
                        loaderText.textContent = `កំពុងវិភាគ៖ (${index + 1}/${employeeData.length}) ${employee.name}`;
                        try {
                           // FIXED: Using a reliable image proxy to bypass CORS issues
                           const imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(employee.photoUrl)}`;
                           const img = await faceapi.fetchImage(imageUrl);
                           const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                           if (!detection) {
                               console.warn(`Could not detect face for: ${employee.name}`);
                               return null;
                           }
                           return new faceapi.LabeledFaceDescriptors(String(employee.id), [detection.descriptor]);
                        } catch (e) {
                           console.error(`Error processing image for ${employee.name} (${employee.photoUrl})`, e);
                           return null;
                        }
                    })
                );
                return descriptors.filter(d => d !== null);

            } catch (error) {
                console.error('Failed to fetch or process employee data:', error);
                loaderText.textContent = 'បរាជ័យក្នុងការទាញយកទិន្នន័យបុគ្គលិក។';
                return [];
            }
        }

        function addLogEntry(data) {
            if(defaultLogMessage) {
                defaultLogMessage.style.display = 'none';
            }

            const logId = `log-${Date.now()}`;
            const actionText = data.action === 'checkin' ? 'Check In' : 'Check Out';
            const actionColor = data.action === 'checkin' ? 'text-green-600' : 'text-red-600';
            const time = new Date(data.time).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const logElement = document.createElement('div');
            logElement.id = logId;
            logElement.className = 'log-entry flex items-center bg-gray-50 p-2 rounded-lg shadow-sm border';
            logElement.innerHTML = `
                <img src="${data.photoUrl}" onerror="this.src='https://placehold.co/60x60/EFEFEF/AAAAAA?text=Error'" class="w-12 h-12 rounded-full object-cover border-2 border-gray-200">
                <div class="flex-grow ml-3">
                    <p class="font-bold text-gray-800">${data.name}</p>
                    <p class="text-sm text-gray-500">${data.id}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold ${actionColor}">${actionText}</p>
                    <p class="text-xs text-gray-500">${time}</p>
                </div>
            `;
            
            logContainer.prepend(logElement);
            
            // Trigger animation
            setTimeout(() => document.getElementById(logId)?.classList.add('visible'), 50);

            // Maintain max log entries
            while (logContainer.children.length > MAX_LOG_ENTRIES) {
                logContainer.lastChild.remove();
            }
        }

        async function processRecognition(employeeId) {
            // Set cooldown
            recentlyProcessed.set(employeeId, Date.now());

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: employeeId })
                });

                if (!response.ok) throw new Error('Failed to record attendance');
                
                const result = await response.json();

                if (result.status === 'success') {
                    console.log('Success:', result);
                    addLogEntry(result);
                } else {
                    console.warn('Attendance not recorded:', result.message);
                }

            } catch (error) {
                 console.error('Error processing recognition:', error);
            }
        }

        function startRecognition() {
            recognitionInterval = setInterval(async () => {
                if (!faceMatcher || video.paused || video.ended) {
                    return;
                }

                const canvasSize = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(overlay, canvasSize);

                const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                                                .withFaceLandmarks()
                                                .withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, canvasSize);

                overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);

                for (const detection of resizedDetections) {
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    const box = detection.detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: bestMatch.toString() });
                    drawBox.draw(overlay);

                    if (bestMatch.label !== 'unknown') {
                        const employeeId = bestMatch.label;
                        const lastProcessedTime = recentlyProcessed.get(employeeId);
                        
                        if (!lastProcessedTime || (Date.now() - lastProcessedTime > RECOGNITION_COOLDOWN)) {
                            console.log(`Recognized: ${employeeId}. Processing...`);
                            processRecognition(employeeId);
                        }
                    }
                }
            }, 1500); // Scan every 1.5 seconds for better performance
        }

        async function initialize() {
            await startVideo();
            video.addEventListener('loadedmetadata', async () => {
                await loadModels();
                const labeledDescriptors = await getLabeledFaceDescriptors();

                if (labeledDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); // Stricter threshold
                    loader.style.display = 'none';
                    startRecognition();
                } else {
                    loaderText.textContent = 'មិនអាចដំណើរការបានទេ ដោយសារគ្មានទិន្នន័យរូបថតត្រឹមត្រូវ។';
                }
            });
        }
        
        initialize();
    </script>
</body>
</html>

