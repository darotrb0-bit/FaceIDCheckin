<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធគ្រប់គ្រងវត្តមានបុគ្គលិក</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            touch-action: manipulation;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: auto;
            transform: scaleX(-1); /* Mirror the video feed */
        }
        video {
            width: 100%;
            border-radius: 0.5rem;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div id="main-container" class="w-full max-w-md mx-auto">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="text-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold">កំពុងរៀបចំប្រព័ន្ធ...</h2>
            <p id="loading-message">សូមរង់ចាំបន្តិច</p>
        </div>

        <!-- Main scanning and result view -->
        <div id="main-view" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
            <!-- Camera View (for scanning) -->
            <div id="camera-view">
                 <h1 class="text-2xl font-bold text-center mb-4 text-teal-300">ប្រព័ន្ធកត់ត្រាវត្តមាន</h1>
                 <p class="text-center text-gray-400 mb-4">សូមដាក់មុខឲ្យចំកាមេរ៉ា</p>
                 <div id="video-container">
                     <video id="face-video" playsinline autoplay muted></video>
                     <canvas id="face-canvas"></canvas>
                 </div>
                 <p id="scan-message" class="text-center mt-4 h-6"></p>
            </div>
        
            <!-- Result View (shown after scan) -->
            <div id="result-view" class="hidden text-center">
                 <div class="mb-4">
                     <img id="employee-photo" class="w-24 h-24 rounded-full mx-auto border-4 border-teal-400" src="https://placehold.co/100x100/334155/e2e8f0?text=..." alt="Employee Photo">
                     <h2 id="employee-name-display" class="text-xl font-bold mt-2"></h2>
                     <p id="employee-id-display" class="text-gray-400"></p>
                 </div>
                 <p id="message" class="text-center mt-4 h-12"></p>
                 <div id="attendance-log" class="mt-4 text-left bg-gray-700 p-4 rounded-lg max-h-48 overflow-y-auto">
                     <h3 class="font-bold mb-2">កំណត់ត្រាវត្តមានថ្ងៃនេះ</h3>
                     <div id="log-content"></div>
                 </div>
            </div>
        </div>

    </div>
    
    <script>
        const faceVideo = document.getElementById('face-video');
        const messageDiv = document.getElementById('message');
        const scanMessageDiv = document.getElementById('scan-message');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const mainView = document.getElementById('main-view');
        const cameraView = document.getElementById('camera-view');
        const resultView = document.getElementById('result-view');
        const logContent = document.getElementById('log-content');

        let employees = [];
        let selectedEmployee = null;
        let currentStream;
        let faceMatcher = null;
        let khmerVoice = null;
        let scanInterval = null;

        // --- Configuration ---
        const GOOGLE_SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const GOOGLE_SHEET_NAME = 'DIList';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVk-h1hW8g-_Z-rViFVzzRN8h1b9fNjoleNjj1gaHd42X3C66vVJi1HJARXYTB81rG/exec';

        // --- Audio Functions ---
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            khmerVoice = voices.find(voice => voice.lang === 'km-KH');
            if (!khmerVoice) console.warn('Khmer (km-KH) voice not found.');
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        
        function speak(text, options = {}) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'km-KH';
                if (khmerVoice) utterance.voice = khmerVoice;
                utterance.rate = options.rate || 1.0;
                utterance.pitch = options.pitch || 1.0;
                utterance.volume = options.volume || 1.0;
                window.speechSynthesis.speak(utterance);
            } else {
                console.error('Speech Synthesis not supported.');
            }
        }
        
        // --- Data Fetching & Preparation ---
        async function fetchEmployeeData() {
            loadingMessage.textContent = 'កំពុងទាញទិន្នន័យបុគ្គលិក...';
            try {
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${GOOGLE_SHEET_NAME}&headers=1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                
                const rows = csvText.split('\n').map(row => row.split('","').map(cell => cell.replace(/"/g, '')));
                employees = rows.slice(8) 
                    .map(row => ({
                        id: row[4],
                        name: row[11],
                        photoUrl: row[26]
                    }))
                    .filter(emp => emp.id && emp.name && emp.photoUrl); 
            } catch (error) {
                console.error('Error fetching employee data:', error);
                loadingMessage.textContent = 'បរាជ័យក្នុងការទាញទិន្នន័យបុគ្គលិក។';
                throw error;
            }
        }

        async function loadAllEmployeeDescriptors() {
            loadingMessage.textContent = 'កំពុងរៀបចំទិន្នន័យផ្ទៃមុខ...';
            const labeledFaceDescriptors = await Promise.all(
                employees.map(async (employee) => {
                    try {
                        const imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(employee.photoUrl.replace('file/d/', 'uc?id=').replace('/view?usp=sharing', ''))}`;
                        const img = await faceapi.fetchImage(imageUrl);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (!detections) {
                            console.warn(`Could not find face for ${employee.name}`);
                            return null;
                        }
                        return new faceapi.LabeledFaceDescriptor(employee.id, [detections.descriptor]);
                    } catch (e) {
                        console.error(`Error processing image for ${employee.name}`, e);
                        return null;
                    }
                })
            );
            return labeledFaceDescriptors.filter(d => d !== null);
        }

        // --- Face Scanning Logic ---
        async function startAutomaticFaceScanner() {
            cameraView.classList.remove('hidden');
            resultView.classList.add('hidden');
            scanMessageDiv.textContent = 'កំពុងរៀបចំកាមេរ៉ា...';
            
            stopAllStreams();
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                faceVideo.srcObject = currentStream;

                scanMessageDiv.textContent = '';

                scanInterval = setInterval(async () => {
                    if (!faceMatcher) return;

                    const detections = await faceapi.detectSingleFace(faceVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    
                    if (detections) {
                        const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
                        if (bestMatch.label !== 'unknown') {
                            stopAllStreams();
                            selectedEmployee = employees.find(emp => emp.id === bestMatch.label);
                            if (selectedEmployee) {
                                handleSuccessfulScan();
                            }
                        } else {
                            scanMessageDiv.textContent = 'មិនស្គាល់ផ្ទៃមុខ';
                        }
                    } else {
                        scanMessageDiv.textContent = '';
                    }
                }, 1500);

            } catch (err) {
                scanMessageDiv.textContent = 'មិនអាចបើកកាមេរ៉ាបានទេ';
                console.error("Camera access error:", err);
            }
        }

        function handleSuccessfulScan() {
            cameraView.classList.add('hidden');
            resultView.classList.remove('hidden');

            document.getElementById('employee-photo').src = `https://images.weserv.nl/?url=${encodeURIComponent(selectedEmployee.photoUrl.replace('file/d/', 'uc?id=').replace('/view?usp=sharing', ''))}`;
            document.getElementById('employee-name-display').textContent = selectedEmployee.name;
            document.getElementById('employee-id-display').textContent = `ID: ${selectedEmployee.id}`;
            
            speak(`សួស្ដី ${selectedEmployee.name}`);
            
            updateLogDisplay();
            submitAttendance();
        }

        // --- Data Submission ---
        function submitAttendance() {
            const lastLog = getTodaysLog().pop();
            const action = (!lastLog || lastLog.action === 'Check Out') ? 'Check In' : 'Check Out';

            messageDiv.textContent = `កំពុងបញ្ជូន ${action}...`;
            messageDiv.className = 'text-center mt-4 h-12 text-yellow-400';

            const data = {
                timestamp: new Date().toISOString(),
                employeeId: selectedEmployee.id,
                employeeName: selectedEmployee.name,
                action: action,
                userAgent: navigator.userAgent
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                messageDiv.textContent = `${action} បានកត់ត្រាដោយជោគជ័យ!`;
                messageDiv.className = 'text-center mt-4 h-12 text-green-500';
                speak(action === 'Check In' ? 'បាន ស្កេន ចូល ជោគជ័យ' : 'បាន ស្កេន ចេញ ជោគជ័យ');
                
                saveLog(action);
                updateLogDisplay();
            })
            .catch(error => {
                console.error('Error submitting attendance:', error);
                messageDiv.textContent = `មានបញ្ហាក្នុងការបញ្ជូនទិន្នន័យ។`;
                messageDiv.className = 'text-center mt-4 h-12 text-red-500';
                speak('បរាជ័យ សូមព្យាយាមម្ដងទៀត');
            })
            .finally(() => {
                // Reset to scanning screen after 5 seconds
                setTimeout(() => {
                    startAutomaticFaceScanner();
                }, 5000);
            });
        }
        
        // --- Local Log for UI ---
        function saveLog(action) {
            const logs = JSON.parse(localStorage.getItem('attendanceLogs') || '{}');
            const today = new Date().toISOString().slice(0, 10);
            if (!logs[selectedEmployee.id]) logs[selectedEmployee.id] = {};
            if (!logs[selectedEmployee.id][today]) logs[selectedEmployee.id][today] = [];

            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit'});
            logs[selectedEmployee.id][today].push({ action, time });
            localStorage.setItem('attendanceLogs', JSON.stringify(logs));
        }

        function getTodaysLog() {
            if (!selectedEmployee) return [];
            const logs = JSON.parse(localStorage.getItem('attendanceLogs') || '{}');
            const today = new Date().toISOString().slice(0, 10);
            return (logs[selectedEmployee.id] && logs[selectedEmployee.id][today]) ? logs[selectedEmployee.id][today] : [];
        }

        function updateLogDisplay() {
            const todaysLog = getTodaysLog();
            if (todaysLog.length === 0) {
                logContent.innerHTML = '<p class="text-gray-400">មិនទាន់មានកំណត់ត្រាសម្រាប់ថ្ងៃនេះ</p>';
            } else {
                logContent.innerHTML = todaysLog.map(log => `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold ${log.action === 'Check In' ? 'text-green-400' : 'text-orange-400'}">${log.action}</span>
                        <span>${log.time}</span>
                    </div>
                `).join('');
            }
        }

        // --- Utility Functions ---
        function stopAllStreams() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        // --- Initialization ---
        async function initialize() {
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                loadingScreen.innerHTML = `<div class="bg-red-900 border border-red-600 p-6 rounded-lg"><h2 class="text-xl font-semibold text-red-300">បញ្ហាសុវត្ថិភាព</h2><p class="mt-2 text-red-200">កម្មវិធីនេះត្រូវតែដំណើរការលើ HTTPS។</p></div>`;
                return;
            }
            
            try {
                loadingMessage.textContent = 'កំពុងផ្ទុក Model សម្គាល់មុខ...';
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/weights/';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                
                await fetchEmployeeData();

                const labeledDescriptors = await loadAllEmployeeDescriptors();
                if (labeledDescriptors.length === 0) {
                    loadingMessage.textContent = 'មិនអាចរៀបចំទិន្នន័យផ្ទៃមុខបានទេ។';
                    return;
                }
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); // 0.5 is the distance threshold
                
                loadingScreen.classList.add('hidden');
                mainView.classList.remove('hidden');
                startAutomaticFaceScanner();

            } catch(error) {
                loadingScreen.innerHTML = `<div class="bg-red-900 border border-red-600 p-6 rounded-lg"><h2 class="text-xl font-semibold text-red-300">ការរៀបចំប្រព័ន្ធបរាជ័យ</h2><p class="mt-2 text-red-200">${error.message}</p></div>`;
                console.error("Initialization failed:", error);
            }
        }

        initialize();
    </script>
</body>
</html>

