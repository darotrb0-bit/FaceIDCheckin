<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធវត្តមានបុគ្គលិក Face Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FIX 1: Correctly link to the minified face-api.js file -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        #video-container {
            position: relative;
            width: 720px;
            height: 560px;
            margin: auto;
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .employee-card img {
            object-fit: cover;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Add Khmer font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ប្រព័ន្ធ Check-in/Check-out វត្តមានបុគ្គលិក</h1>

        <div class="flex flex-col lg:flex-row gap-8 items-center justify-center">
            <!-- Camera and Recognition Area -->
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div id="video-container" class="rounded-lg overflow-hidden border-2 border-gray-300">
                    <video id="video" width="720" height="560" autoplay muted></video>
                    <canvas id="canvas"></canvas>
                </div>
            </div>

            <!-- Employee Information and Status Area -->
            <div class="w-full lg:w-96">
                <div id="info-card" class="bg-white p-6 rounded-lg shadow-md text-center">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">ព័ត៌មានបុគ្គលិក</h2>
                    <div id="employee-details" class="hidden">
                        <img id="employee-image" src="https://placehold.co/150x150/EFEFEF/AAAAAA?text=រូបថត" alt="Employee Photo" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-gray-200">
                        <h3 id="employee-name" class="text-2xl font-semibold text-blue-600"></h3>
                        <p id="employee-id" class="text-gray-500 text-lg"></p>
                    </div>
                     <div id="status-message" class="mt-4 p-4 rounded-lg text-lg font-semibold">
                       <p id="loading-status">សូមរង់ចាំ, កំពុងដំណើរការប្រព័ន្ធ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mb-4"></div>
        <h2 id="loading-text" class="text-center text-white text-xl font-semibold">កំពុងដំណើរការ...</h2>
        <p class="w-1/3 text-center text-white mt-2">កំពុងទាញយក Model សម្រាប់ការស្គាល់ផ្ទៃមុខ។ សូមរង់ចាំបន្តិច...</p>
    </div>


    <script>
        // ============================ CONFIGURATION ============================
        // !!! សូមបំពេញព័ត៌មានខាងក្រោម !!!
        const GOOGLE_API_KEY = 'AIzaSyB1CFt9wduahxHq0AalovL_-x_g9qy4H9Y'; // *** ដាក់ Google Sheets API Key របស់អ្នកនៅទីនេះ
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxwSJYdzVMweOyJbPJ-ChnRE01vX0rS04tlfYPPp687_y4_LP4ilFPwBB5joPe-_91u/exec'; // *** ដាក់ URL របស់ Google Apps Script Web App របស់អ្នកនៅទីនេះ

        // Google Sheet សម្រាប់បញ្ជីឈ្មោះបុគ្គលិក
        const EMPLOYEE_SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const EMPLOYEE_SHEET_NAME = 'DIList';
        // =======================================================================


        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const loadingStatus = document.getElementById('loading-status');
        
        const employeeDetails = document.getElementById('employee-details');
        const employeeImage = document.getElementById('employee-image');
        const employeeName = document.getElementById('employee-name');
        const employeeId = document.getElementById('employee-id');
        const statusMessage = document.getElementById('status-message');

        let labeledFaceDescriptors = null;
        let lastCheckInTime = {}; // Object to store the last check-in time for each employee ID

        // Function to start the video stream
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => console.error('Error accessing camera: ', err));
        }

        // Function to load face recognition models
        async function loadModels() {
            // FIX 2: Load models from the local 'models' folder
            const MODEL_URL = 'models';
            loadingText.innerText = 'កំពុងទាញយក Models...';
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            startVideo();
        }

        // Function to fetch employee data and create labeled face descriptors
        async function getLabeledFaceDescriptors() {
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY === 'YOUR_GOOGLE_API_KEY') {
                alert('សូមបញ្ចូល Google Sheets API Key របស់អ្នកនៅក្នុងកូដ។');
                return null;
            }

            loadingText.innerText = 'កំពុងទាញយកបញ្ជីឈ្មោះបុគ្គលិក...';
            const ranges = [`${EMPLOYEE_SHEET_NAME}!E9:E`, `${EMPLOYEE_SHEET_NAME}!L9:L`, `${EMPLOYEE_SHEET_NAME}!AA9:AA`];
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${EMPLOYEE_SHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${GOOGLE_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const ids = data.valueRanges[0].values.flat();
                const names = data.valueRanges[1].values.flat();
                const imageUrls = data.valueRanges[2].values.flat();

                const employees = ids.map((id, index) => ({
                    id: id,
                    name: names[index],
                    imageUrl: imageUrls[index]
                }));

                const descriptors = [];
                for (let i = 0; i < employees.length; i++) {
                    const employee = employees[i];
                    if (!employee.id || !employee.name || !employee.imageUrl) continue;
                    
                    loadingText.innerText = `កំពុងវិភាគរូបថតបុគ្គលិក ${i + 1}/${employees.length}: ${employee.name}`;
                    try {
                        // Use a proxy to avoid CORS issues
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const img = await faceapi.fetchImage(proxyUrl + employee.imageUrl);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (detections) {
                            // Use employee ID as the label for uniqueness
                            descriptors.push(new faceapi.LabeledFaceDescriptors(employee.id, [detections.descriptor]));
                        } else {
                            console.warn(`រកមិនឃើញផ្ទៃមុខក្នុងរូបថតសម្រាប់: ${employee.name}`);
                        }
                    } catch (e) {
                        console.error(`មិនអាចទាញយករូបថតបានសម្រាប់ ${employee.name}:`, e);
                    }
                }
                
                // Store employee data in a global map for easy access
                window.employeeDataMap = new Map(employees.map(emp => [emp.id, emp]));

                return descriptors;

            } catch (error) {
                console.error("Error fetching sheet data:", error);
                loadingOverlay.innerText = `មានបញ្ហាក្នុងការទាញយកទិន្នន័យពី Google Sheet: ${error.message}`;
                alert(`មានបញ្ហាក្នុងការទាញយកទិន្នន័យពី Google Sheet: ${error.message}\nសូមពិនិត្យមើល API Key និង Sheet ID របស់អ្នក។`);
                return null;
            }
        }

        // Function to record attendance by calling Google Apps Script
        async function recordAttendance(employeeId) {
             if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL') {
                console.error('GAS Web App URL is not configured.');
                return;
            }
            
            // Cooldown: Prevent checking in the same person within 60 seconds
            const now = Date.now();
            if (lastCheckInTime[employeeId] && (now - lastCheckInTime[employeeId] < 60000)) {
                console.log(`Cooldown for ${employeeId}. Please wait.`);
                return;
            }
            lastCheckInTime[employeeId] = now;

            statusMessage.textContent = `កំពុងកត់ត្រាវត្តមានសម្រាប់ ${window.employeeDataMap.get(employeeId).name}...`;
            statusMessage.className = 'mt-4 p-4 rounded-lg text-lg font-semibold bg-yellow-100 text-yellow-800';
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Apps Script web apps often require this
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeId: employeeId })
                });

                statusMessage.textContent = 'បានកត់ត្រាដោយជោគជ័យ!';
                statusMessage.className = 'mt-4 p-4 rounded-lg text-lg font-semibold bg-green-100 text-green-800';

            } catch (error) {
                console.error('Error recording attendance:', error);
                statusMessage.textContent = 'ការកត់ត្រាមានបញ្ហា។';
                statusMessage.className = 'mt-4 p-4 rounded-lg text-lg font-semibold bg-red-100 text-red-800';
            }

            // Reset status after a few seconds
            setTimeout(() => {
                statusMessage.textContent = 'សូមឈរនៅមុខកាមេរ៉ា។';
                statusMessage.className = 'mt-4 p-4 rounded-lg text-lg font-semibold bg-gray-100 text-gray-800';
                employeeDetails.classList.add('hidden');
            }, 5000);
        }


        video.addEventListener('play', async () => {
            if (!labeledFaceDescriptors) {
                labeledFaceDescriptors = await getLabeledFaceDescriptors();
                if (!labeledFaceDescriptors || labeledFaceDescriptors.length === 0) {
                    loadingText.innerText = "បរាជ័យក្នុងការរៀបចំប្រព័ន្ធ។ សូមពិនិត្យ Console។";
                    loadingOverlay.style.display = 'flex'; // Show overlay again on failure
                    return;
                }
            }
            
            loadingOverlay.style.display = 'none';
            loadingStatus.textContent = 'សូមឈរនៅមុខកាមេរ៉ា។';

            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5); // Confidence threshold

            canvas.width = video.width;
            canvas.height = video.height;
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);

                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                    drawBox.draw(canvas);

                    if (result.label !== 'unknown') {
                        const employeeInfo = window.employeeDataMap.get(result.label);
                        if (employeeInfo) {
                           // Display employee info
                           employeeDetails.classList.remove('hidden');
                           employeeImage.src = employeeInfo.imageUrl;
                           employeeName.textContent = employeeInfo.name;
                           employeeId.textContent = `អត្តលេខ: ${employeeInfo.id}`;

                           // Record attendance
                           recordAttendance(employeeInfo.id);
                        }
                    }
                });

            }, 2000); // Run recognition every 2 seconds
        });

        loadModels();

    </script>
</body>
</html>

